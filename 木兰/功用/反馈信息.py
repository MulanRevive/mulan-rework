import ast, re, sys, traceback
from pathlib import Path

from æœ¨å…°.åˆ†æå™¨.è¯æ³•åˆ†æå™¨ import åˆ†è¯å™¨
from æœ¨å…°.åˆ†æå™¨.è¯­æ³•åˆ†æå™¨ import è¯­æ³•åˆ†æå™¨

è¿è¡Œæ—¶æœ¨å…°è·¯å¾„ = str(Path("site-packages/æœ¨å…°/"))

æŠ¥é”™_åˆ—è¡¨ç´¢å¼• = "å–åˆ—è¡¨å†…å®¹æ—¶ï¼Œç´¢å¼•è¶…å‡ºèŒƒå›´"
æŠ¥é”™_å±‚çº§ = "è°ƒç”¨å±‚çº§å¦‚ä¸‹"
æŠ¥é”™_é™¤é›¶ = "è¯·å‹¿é™¤ä»¥é›¶"
æŠ¥é”™_é€’å½’ = "é€’å½’è¿‡æ·±ã€‚è¯·ç¡®è®¤: 1ã€çš„ç¡®éœ€è¦é€’å½’ 2ã€é€’å½’çš„æ”¶æ•›æ­£ç¡®"
æŠ¥é”™_æŒ‰ç´¢å¼•å–é¡¹ = "ä¸æ”¯æŒæŒ‰ç´¢å¼•å–é¡¹"
æŠ¥é”™_æ— å±æ€§ = "æ²¡æœ‰å±æ€§"
å‚è€ƒ_enter = "\nå‚è€ƒï¼šhttps://stackoverflow.com/questions/1984325/explaining-pythons-enter-and-exit"

def åé¦ˆä¿¡æ¯(ä¾‹å¤–, æºç æ–‡ä»¶=None):
    æç¥ç¬¦ = " ğŸ˜° "
    if sys.platform == 'win32':
        æç¥ç¬¦ = "ï¼ˆ>ï¹<ï¼‰"
    return æç¥ç¬¦ + "\n".join(ä¸­æ–‡åŒ–(ä¾‹å¤–, æºç æ–‡ä»¶))

def ä¸­æ–‡åŒ–(ä¾‹å¤–, æºç æ–‡ä»¶=None):
    ç±»å‹ = ä¾‹å¤–.__class__.__name__
    åŸä¿¡æ¯ = str(ä¾‹å¤–)
    exc_type, exc_value, å›æº¯ä¿¡æ¯ = sys.exc_info()
    å„å±‚ = traceback.extract_tb(å›æº¯ä¿¡æ¯)
    # print(repr(å„å±‚))
    å„è¡Œ = []

    è¡Œä¿¡æ¯ = æå–(å„å±‚)
    if len(è¡Œä¿¡æ¯) > 0:
        å…³é”® = å–å…³é”®ä¿¡æ¯(æç¤º(ç±»å‹, åŸä¿¡æ¯), è¡Œä¿¡æ¯[0])
    å„è¡Œ.append(å…³é”®)
    for è¡Œå·, è¡Œ in enumerate(è¡Œä¿¡æ¯, start=1):
        if æºç æ–‡ä»¶ is None and è¡Œ.æ–‡ä»¶å == "ã€æ ‡å‡†è¾“å…¥ã€‘":
            return [å…³é”® + f"ï¼Œè§ç¬¬{è¡Œ.è¡Œå·}è¡Œ"]
        else:
            # åœ¨ç¬¬äºŒå±‚å‰æ˜¾ç¤º
            if è¡Œå· == 2:
                å„è¡Œ.append(æŠ¥é”™_å±‚çº§)

            å„è¡Œ.append(("è§" if è¡Œ.æ–‡ä»¶å == æºç æ–‡ä»¶ else f"â€œ{è¡Œ.æ–‡ä»¶å}â€") + f"ç¬¬{è¡Œ.è¡Œå·}è¡Œï¼š{è¡Œ.å†…å®¹}")
    return å„è¡Œ

class å±‚ä¿¡æ¯:
    def __init__(self, è¡Œå·, å†…å®¹, æ–‡ä»¶å):
        self.è¡Œå·, self.å†…å®¹, self.æ–‡ä»¶å = è¡Œå·, å†…å®¹, æ–‡ä»¶å

def æå–(å„å±‚):
    å„è¡Œ = []
    for å±‚å· in range(len(å„å±‚) - 1, -1, -1):
        å±‚ = å„å±‚[å±‚å·]
        æ–‡ä»¶å = å±‚.filename
        if æ–‡ä»¶å.find(è¿è¡Œæ—¶æœ¨å…°è·¯å¾„) == -1:
            å„è¡Œ.append(å±‚ä¿¡æ¯(å±‚.lineno, å±‚.line, æ–‡ä»¶å))

    return å„è¡Œ

def å–å…³é”®ä¿¡æ¯(åŸºæœ¬ä¿¡æ¯, é¦–è¡Œ):
    ä»£ç è¡Œ = é¦–è¡Œ.å†…å®¹
    é—®é¢˜å˜é‡ = []
    try:
        if åŸºæœ¬ä¿¡æ¯.find(æŠ¥é”™_æŒ‰ç´¢å¼•å–é¡¹) > 0:
            èŠ‚ç‚¹ = è¯­æ³•åˆ†æå™¨(åˆ†è¯å™¨).åˆ†æ(ä»£ç è¡Œ)
            é—®é¢˜å˜é‡ = è¯Šæ–­é—®é¢˜(èŠ‚ç‚¹)
        åŒ¹é… = re.search("(.*)" + æŠ¥é”™_æ— å±æ€§ + "â€˜(.*)â€™", åŸºæœ¬ä¿¡æ¯)
        if åŒ¹é…:
            èŠ‚ç‚¹ = è¯­æ³•åˆ†æå™¨(åˆ†è¯å™¨).åˆ†æ(ä»£ç è¡Œ)

            # TODO: é‡æ„ä»¥é¿å…é‡å¤åŒ¹é…
            é—®é¢˜å±æ€§ = åŒ¹é….group(2)
            é—®é¢˜å˜é‡ = è¯Šæ–­æ— å±æ€§é—®é¢˜(èŠ‚ç‚¹, é—®é¢˜å±æ€§)
    except ValueError:
        return åŸºæœ¬ä¿¡æ¯

    if len(é—®é¢˜å˜é‡) == 0:
        return åŸºæœ¬ä¿¡æ¯
    elif len(é—®é¢˜å˜é‡) == 1:
        return f"{åŸºæœ¬ä¿¡æ¯}ï¼Œçœ‹çœ‹â€˜{é—®é¢˜å˜é‡[0]}â€™"
    else:
        return f"{åŸºæœ¬ä¿¡æ¯}ï¼Œçœ‹çœ‹{é—®é¢˜å˜é‡}"


def è¯Šæ–­é—®é¢˜(èŠ‚ç‚¹):
    æ‰€æœ‰å˜é‡ = []
    if isinstance(èŠ‚ç‚¹, list):
        for å­èŠ‚ç‚¹ in èŠ‚ç‚¹:
            æ‰€æœ‰å˜é‡ += è¯Šæ–­é—®é¢˜(å­èŠ‚ç‚¹)
    elif isinstance(èŠ‚ç‚¹, int) or isinstance(èŠ‚ç‚¹, str):
        pass
    else:
        if èŠ‚ç‚¹ == None:
            return
        for å±æ€§ in ast.iter_fields(èŠ‚ç‚¹):
            if type(èŠ‚ç‚¹).__name__ == "Subscript":
                if å±æ€§[0] == "value":
                    return [å±æ€§[1].id]
            æ‰€æœ‰å˜é‡ += è¯Šæ–­é—®é¢˜(å±æ€§[1])
    return æ‰€æœ‰å˜é‡

def è¯Šæ–­æ— å±æ€§é—®é¢˜(èŠ‚ç‚¹, é—®é¢˜å±æ€§):
    æ‰€æœ‰å˜é‡ = []
    if isinstance(èŠ‚ç‚¹, list):
        for å­èŠ‚ç‚¹ in èŠ‚ç‚¹:
            æ‰€æœ‰å˜é‡ += è¯Šæ–­æ— å±æ€§é—®é¢˜(å­èŠ‚ç‚¹, é—®é¢˜å±æ€§)
    elif isinstance(èŠ‚ç‚¹, int) or isinstance(èŠ‚ç‚¹, str):
        pass
    else:
        if èŠ‚ç‚¹ == None:
            return
        æœ‰é—®é¢˜ = False
        å¯¹è±¡å = ""
        for å±æ€§ in ast.iter_fields(èŠ‚ç‚¹):
            if type(èŠ‚ç‚¹).__name__ == "Attribute":
                # print(å±æ€§[0] + ": " + å±æ€§[1])
                if å±æ€§[0] == "value":
                    å¯¹è±¡å = å±æ€§[1].id
                elif å±æ€§[0] == "attr" and å±æ€§[1] == é—®é¢˜å±æ€§:
                    æœ‰é—®é¢˜ = True
            æ‰€æœ‰å˜é‡ += è¯Šæ–­æ— å±æ€§é—®é¢˜(å±æ€§[1], é—®é¢˜å±æ€§)
        if æœ‰é—®é¢˜:
            return [å¯¹è±¡å]
    return æ‰€æœ‰å˜é‡

def æç¤º(ç±»å‹, åŸä¿¡æ¯):
    if ç±»å‹ == 'NameError':
        return re.sub(r"name '(.*)' is not defined", r"è¯·å…ˆå®šä¹‰â€˜\1â€™å†ä½¿ç”¨", åŸä¿¡æ¯)
    elif ç±»å‹ == 'ZeroDivisionError':
        return æŠ¥é”™_é™¤é›¶
    elif ç±»å‹ == 'RecursionError':
        return æŠ¥é”™_é€’å½’
    elif ç±»å‹ == 'UnboundLocalError':
        return re.sub(
            r"local variable '(.*)' referenced before assignment",
            r"è¯·å…ˆå¯¹æœ¬åœ°å˜é‡â€˜\1â€™èµ‹å€¼å†å¼•ç”¨",
            åŸä¿¡æ¯)
    elif ç±»å‹ == 'KeyError':
        return "å­—å…¸ä¸­ä¸å­˜åœ¨æ­¤é”®ï¼š" + åŸä¿¡æ¯
    elif ç±»å‹ == 'TypeError':
        æ¨¡å¼ = 'can only concatenate str \(not "(.*)"\) to str'
        æ— æ³•å–é¡¹ = "'(.*)' object is not subscriptable"
        if re.match(æ¨¡å¼, åŸä¿¡æ¯):
            return re.sub(æ¨¡å¼, r'å­—ç¬¦ä¸²åªèƒ½æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè¯·å°†â€œ\1â€å…ˆç”¨ str() è½¬æ¢', åŸä¿¡æ¯)
        åŒ¹é… = re.search(æ— æ³•å–é¡¹, åŸä¿¡æ¯)
        if åŒ¹é…:
            return f'{ç±»å‹ä¸­æ–‡åŒ–(åŒ¹é….group(1))}{æŠ¥é”™_æŒ‰ç´¢å¼•å–é¡¹}'
    elif ç±»å‹ == 'IndexError' and åŸä¿¡æ¯ == "list index out of range":
        return æŠ¥é”™_åˆ—è¡¨ç´¢å¼•
    elif ç±»å‹ == 'AttributeError':
        ä¿¡æ¯ = "éœ€è¦æ·»åŠ æ­¤å±æ€§ï¼š" + åŸä¿¡æ¯
        if åŸä¿¡æ¯ == "__enter__":
            ä¿¡æ¯ += å‚è€ƒ_enter
            return ä¿¡æ¯

        æ— å±æ€§ = "'(.*)' object has no attribute '(.*)'"
        åŒ¹é… = re.search(æ— å±æ€§, åŸä¿¡æ¯)
        if åŒ¹é…:
            return f'{ç±»å‹ä¸­æ–‡åŒ–(åŒ¹é….group(1))}{æŠ¥é”™_æ— å±æ€§}â€˜{åŒ¹é….group(2)}â€™'
    elif ç±»å‹ == 'FileNotFoundError':
        return re.sub(r"\[Errno 2\] No such file or directory: '(.*)'",
            r"æ²¡æ‰¾åˆ°æ–‡ä»¶æˆ–è·¯å¾„ï¼šâ€˜\1â€™",
            åŸä¿¡æ¯)
    elif ç±»å‹ == 'ModuleNotFoundError':
        return re.sub(r"No module named '(.*)'", r"æ²¡æ‰¾åˆ°æ¨¡å—ï¼šâ€˜\1â€™", åŸä¿¡æ¯)
    return ç±»å‹ + "ï¼š" + åŸä¿¡æ¯

def ç±»å‹ä¸­æ–‡åŒ–(ç±»å‹):
    ä¸­è‹±è¡¨ = {
        "NoneType": "ç©ºå˜é‡",
        "int": "æ•´æ•°å˜é‡",
        "bool": "çœŸå‡å˜é‡",
        "function": "å‡½æ•°",
    }
    return ä¸­è‹±è¡¨[ç±»å‹] if ç±»å‹ in ä¸­è‹±è¡¨ else ç±»å‹
